From cf14edeed5234185305520da2830a66fc98ce448 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Thu, 21 Sep 2017 19:11:38 -0500
Subject: [PATCH 09/10] Fallback to system compilers if
 (psuedo-)cross-compilers not found

---
 Lib/distutils/sysconfig.py |  3 ++
 Lib/sysconfig.py           | 68 ++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 71 insertions(+)

diff --git a/Lib/distutils/sysconfig.py b/Lib/distutils/sysconfig.py
index de7da1d..45d0c20 100644
--- a/Lib/distutils/sysconfig.py
+++ b/Lib/distutils/sysconfig.py
@@ -466,6 +466,9 @@ def get_config_vars(*args):
         if sys.platform == 'darwin':
             import _osx_support
             _osx_support.customize_config_vars(_config_vars)
+        if sys.platform in ('darwin', 'linux'):
+            from sysconfig import conda_customize_compiler
+            conda_customize_compiler(_config_vars)
 
     if args:
         vals = []
diff --git a/Lib/sysconfig.py b/Lib/sysconfig.py
index 9c8350d..9ca75ea 100644
--- a/Lib/sysconfig.py
+++ b/Lib/sysconfig.py
@@ -445,6 +445,68 @@ def get_path(name, scheme=_get_default_scheme(), vars=None, expand=True):
     """
     return get_paths(scheme, vars, expand)[name]
 
+def conda_customize_compiler(_config_vars):
+    """
+    It may be the case that this should get called from
+    Lib/distutils/sysconfig.py instead so that startup
+    time is not compromised when not compiling. Then again
+    _find_executable would be sped up if that was important.
+    """
+    _CONDA_CROSS_KEYS = ('AR', 'BLDSHARED', 'BLDSHARED', 'CC', 'CFLAGS', 'CXX',
+                         'CXX', 'HOST_GNU_TYPE', 'LDCXXSHARED', 'LDSHARED',
+                         'LINKCC', 'MAINCC', 'RANLIB', 'READELF')
+    from _osx_support import _find_executable
+    replacements = dict({})
+    is_gcc = False
+    for compiler in ('CC', 'CXX'):
+        # If any os.environ[compiler] has '-conda_' in it
+        # then do not replace anything.
+        if compiler in os.environ:
+            if '-conda_' in os.environ[compiler]:
+                return
+        if compiler in _config_vars:
+            oldcc = _config_vars[compiler].split()[0]
+            cc = _find_executable(oldcc)
+            if cc and '-conda_' in cc:
+                return
+            if '-' in oldcc:
+                cc = _find_executable(oldcc.split('-')[-1])
+            if cc:
+                replacements[oldcc] = cc
+            if oldcc in replacements and 'gcc' in replacements[oldcc]:
+                is_gcc = True
+    if len(replacements) > 0:
+        # Remove some flags that older GCCs do not support
+        if is_gcc:
+            replacements['-fno-plt'] = ''
+            replacements['-mtune=haswell'] = ''
+            replacements['-fstack-protector-strong'] = ''
+        if 'HOST_GNU_TYPE' in _config_vars:
+            host_gnu_type = _config_vars['HOST_GNU_TYPE']
+            # Get HOST_GNU_TYPE from cc -dumpmachine
+            if len(host_gnu_type):
+                if sys.platform == 'darwin':
+                    from platform import release
+                    host_gnu_type = 'x86_64-apple-darwin%s' % release()
+                elif sys.platform.startswith('linux'):
+                    if 32 == 8 * tuple.__itemsize__:
+                        host_gnu_type = 'i686-redhat-linux'
+                    else:
+                        host_gnu_type = 'x86_64-redhat-linux'
+                if host_gnu_type and host_gnu_type != _config_vars['HOST_GNU_TYPE']:
+                    replacements[_config_vars['HOST_GNU_TYPE']] = host_gnu_type
+        for cv in _CONDA_CROSS_KEYS:
+            if cv in _config_vars:
+                # Replace in order of longest first so substrings do not get replaced.
+                newcv = oldcv = _config_vars[cv]
+                for k in sorted(replacements, key=lambda k: len(replacements[k]), reverse=False):
+                    newcv = newcv.replace(k, replacements[k])
+                if newcv != oldcv:
+                    # TODO :: Take care about _INITPRE (backup of original values in _osx_support,
+                    #         read comment in get_platform_osx. Do we need to do this? I hope not.
+                    _config_vars[cv] = newcv
+    return _config_vars
+
 def get_config_vars(*args):
     """With no arguments, return a dictionary of all configuration
     variables relevant for the current platform.
@@ -502,6 +564,12 @@ def get_config_vars(*args):
                 srcdir = os.path.join(base, _CONFIG_VARS['srcdir'])
                 _CONFIG_VARS['srcdir'] = os.path.normpath(srcdir)
 
+        # Handle conda-specific (pseudo)-cross-compiler. This is very
+        # similar to _osx_support.customize_config_vars() but not macOS
+        # specific.
+        if os.name == 'posix':
+            conda_customize_compiler(_CONFIG_VARS)
+
         # OS X platforms require special customization to handle
         # multi-architecture, multi-os-version installers
         if sys.platform == 'darwin':
-- 
1.8.3.1

