From 2d33a359ac5308ebf6dbf4dcab94bcc954004265 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Fri, 2 Oct 2020 00:03:12 +0200
Subject: [PATCH 18/25] cross compile darwin

By Isuru Fernando.
---
 Lib/platform.py | 7 ++++++-
 configure       | 5 ++++-
 configure.ac    | 5 ++++-
 setup.py        | 6 +++---
 4 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/configure b/configure
index f227dd88c0..2e2a4a6628 100755
--- a/configure	2022-03-21 14:06:54.541526845 +0300
+++ b/configure	2022-03-21 14:07:04.705697427 +0300
@@ -3393,6 +3393,9 @@
 			_host_cpu=$host_cpu
 		esac
 		;;
+	*-*-darwin*)
+		_host_cpu=$host_cpu
+		;;
 	*-*-cygwin*)
 		_host_cpu=
 		;;
@@ -6250,7 +6253,7 @@
   fi
 fi
 
-if test "$cross_compiling" = yes; then
+if test "$cross_compiling" = yes -a "$ac_sys_system" != "Darwin"; then
     case "$READELF" in
 	readelf|:)
 	as_fn_error $? "readelf for the host is required for cross builds" "$LINENO" 5
diff --git a/configure.ac b/configure.ac
index f70a69b2f9..f58eb5c607 100644
--- a/configure.ac	2022-03-21 14:06:54.545526912 +0300
+++ b/configure.ac	2022-03-21 14:07:04.705697427 +0300
@@ -448,6 +448,9 @@
 			_host_cpu=$host_cpu
 		esac
 		;;
+	*-*-darwin*)
+		_host_cpu=$host_cpu
+		;;
 	*-*-cygwin*)
 		_host_cpu=
 		;;
@@ -1211,7 +1214,7 @@
 fi
 
 AC_CHECK_TOOLS([READELF], [readelf], [:])
-if test "$cross_compiling" = yes; then
+if test "$cross_compiling" = yes -a "$ac_sys_system" != "Darwin"; then
     case "$READELF" in
 	readelf|:)
 	AC_MSG_ERROR([readelf for the host is required for cross builds])
diff --git a/Lib/platform.py b/Lib/platform.py
index 134fbae6b1..fbf27ac7d3 100755
--- a/Lib/platform.py	2022-03-21 14:06:54.541526845 +0300
+++ b/Lib/platform.py	2022-03-21 14:07:04.701697360 +0300
@@ -411,7 +411,12 @@
 def _mac_ver_xml():
     fn = '/System/Library/CoreServices/SystemVersion.plist'
     if not os.path.exists(fn):
-        return None
+        if 'SDKROOT' in os.environ:
+            fn = os.environ['SDKROOT'] + fn
+            if not os.path.exists(fn):
+                return None
+        else:
+            return None
 
     try:
         import plistlib
diff --git a/setup.py b/setup.py
index 783d20bdcd..36119d3ba9 100644
--- a/setup.py	2022-03-21 14:06:54.545526912 +0300
+++ b/setup.py	2022-03-21 14:07:04.705697427 +0300
@@ -83,7 +83,7 @@
 HOST_PLATFORM = get_platform()
 MS_WINDOWS = (HOST_PLATFORM == 'win32')
 CYGWIN = (HOST_PLATFORM == 'cygwin')
-MACOS = (HOST_PLATFORM == 'darwin')
+MACOS = (HOST_PLATFORM.startswith('darwin'))
 AIX = (HOST_PLATFORM.startswith('aix'))
 VXWORKS = ('vxworks' in HOST_PLATFORM)
 CC = os.environ.get("CC")
@@ -1078,11 +1078,11 @@
                 readline_lib = 'readline'
             do_readline = self.compiler.find_library_file(self.lib_dirs,
                 readline_lib)
-            if CROSS_COMPILING:
+            if CROSS_COMPILING and not MACOS:
                 ret = run_command("%s -d %s | grep '(NEEDED)' > %s"
                                 % (sysconfig.get_config_var('READELF'),
                                    do_readline, tmpfile))
-            elif find_executable('ldd'):
+            elif find_executable('ldd') and not MACOS:
                 ret = run_command("ldd %s > %s" % (do_readline, tmpfile))
             else:
                 ret = 1
